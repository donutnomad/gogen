// Code generated by gogen. DO NOT EDIT.
package examples

import (
	"errors"

	"gorm.io/datatypes"
)

// ================ stateflow ================

// æµç¨‹å›¾ï¼š
// ```
//                                                                                                                                         â”Œâ”€â”€â–¶ Ready(Enabled) ğŸ”
//                                                                                                                                         â”‚
//                                                               â”Œâ”€â”€ <COMMIT> â”€â”€â–¶ Ready(Disabled) â”€â”€â–¶ Deleting (via)â”€â”€ <COMMIT> â”€â”€â–¶ Deleted
//                                                               â”‚                                                                         â”‚
//                                                               â”‚                                                                         â””â”€â”€ <REJECT> â”€â”€â–¶ Ready(Disabled) ğŸ”
//                                                               â”‚
//                                                               â”œâ”€â”€ <REJECT> â”€â”€â–¶ Ready(Enabled) ğŸ”
//                                                               â”‚
//                         â”Œâ”€â”€â–¶ Ready(Enabled) â”€â”€â–¶ Deleting (via)
//                         â”‚                                     â”‚
//                         â”‚                                     â”œâ”€â”€ <COMMIT> â”€â”€â–¶ Deleted
//                         â”‚                                     â”‚
//                         â”‚                                     â””â”€â”€ <REJECT> â”€â”€â–¶ Ready(Enabled) ğŸ”
// Init â”€â”€â–¶ Provisioning â”€â”€â”¤
//                         â”‚
//                         â”‚
//                         â”‚                             â”Œâ”€â”€ <COMMIT> â”€â”€â–¶ Deleted
//                         â”‚                             â”‚
//                         â””â”€â”€â–¶ Failed â”€â”€â–¶ Deleting (via)
//                                                       â”‚
//                                                       â””â”€â”€ <REJECT> â”€â”€â–¶ Failed ğŸ”
// ```

// ServerPhase é˜¶æ®µæšä¸¾
type ServerPhase string

const (
	ServerPhaseInit         ServerPhase = "Init"
	ServerPhaseProvisioning ServerPhase = "Provisioning"
	ServerPhaseReady        ServerPhase = "Ready"
	ServerPhaseFailed       ServerPhase = "Failed"
	ServerPhaseUpdating     ServerPhase = "Updating"
	ServerPhaseDeleted      ServerPhase = "Deleted"
	ServerPhaseDeleting     ServerPhase = "Deleting"
)

var ServerPhaseEnums = struct {
	Init         ServerPhase
	Provisioning ServerPhase
	Ready        ServerPhase
	Failed       ServerPhase
	Updating     ServerPhase
	Deleted      ServerPhase
	Deleting     ServerPhase
}{
	Init:         ServerPhaseInit,
	Provisioning: ServerPhaseProvisioning,
	Ready:        ServerPhaseReady,
	Failed:       ServerPhaseFailed,
	Updating:     ServerPhaseUpdating,
	Deleted:      ServerPhaseDeleted,
	Deleting:     ServerPhaseDeleting,
}

// ServerStatus çŠ¶æ€æšä¸¾
type ServerStatus string

const (
	ServerStatusNone     ServerStatus = ""
	ServerStatusDisabled ServerStatus = "Disabled"
	ServerStatusEnabled  ServerStatus = "Enabled"
)

var ServerStatusEnums = struct {
	None     ServerStatus
	Disabled ServerStatus
	Enabled  ServerStatus
}{
	None:     ServerStatusNone,
	Disabled: ServerStatusDisabled,
	Enabled:  ServerStatusEnabled,
}

// ServerStage é˜¶æ®µï¼ˆPhase + Statusï¼‰
type ServerStage struct {
	Phase  ServerPhase  `json:"phase"`
	Status ServerStatus `json:"status"`
}

// é¢„å®šä¹‰é˜¶æ®µ
var (
	StageServerInit          = ServerStage{ServerPhaseInit, ServerStatusNone}
	StageServerProvisioning  = ServerStage{ServerPhaseProvisioning, ServerStatusNone}
	StageServerReadyDisabled = ServerStage{ServerPhaseReady, ServerStatusDisabled}
	StageServerReadyEnabled  = ServerStage{ServerPhaseReady, ServerStatusEnabled}
	StageServerFailed        = ServerStage{ServerPhaseFailed, ServerStatusNone}
	StageServerUpdating      = ServerStage{ServerPhaseUpdating, ServerStatusNone}
	StageServerDeleted       = ServerStage{ServerPhaseDeleted, ServerStatusNone}
	StageServerDeleting      = ServerStage{ServerPhaseDeleting, ServerStatusNone}
)

// ServerPendingTransition å®¡æ‰¹äº‹åŠ¡
type ServerPendingTransition struct {
	From     ServerStage `json:"from"`
	To       ServerStage `json:"to"`
	Fallback ServerStage `json:"fallback"`
}

// ServerState å®Œæ•´çŠ¶æ€
type ServerState struct {
	Current ServerStage              `json:"current"`
	Pending *ServerPendingTransition `json:"pending,omitempty"`
}

// ServerStateColumns æ•°æ®åº“å­˜å‚¨ç»“æ„
type ServerStateColumns struct {
	Phase   ServerPhase                                  `gorm:"column:phase" json:"phase"`
	Status  ServerStatus                                 `gorm:"column:status" json:"status"`
	Pending datatypes.JSONType[*ServerPendingTransition] `gorm:"column:pending" json:"pending"`
}

func (s ServerState) ToColumns() ServerStateColumns {
	return ServerStateColumns{
		Phase:   s.Current.Phase,
		Status:  s.Current.Status,
		Pending: datatypes.NewJSONType(s.Pending),
	}
}

func (c ServerStateColumns) ToState() ServerState {
	return ServerState{
		Current: ServerStage{Phase: c.Phase, Status: c.Status},
		Pending: c.Pending.Data(),
	}
}

// é”™è¯¯å®šä¹‰
var (
	ErrServerInvalidTransition  = errors.New("invalid transition")
	ErrServerApprovalInProgress = errors.New("approval in progress")
	ErrServerNotInApproval      = errors.New("not in approval")
)

func (s ServerState) TransitionTo(to ServerStage, withApproval bool) (ServerState, error) {
	switch s.Current {
	case StageServerInit:
		switch to {
		case StageServerProvisioning:
			return ServerState{Current: to}, nil
		}
	case StageServerProvisioning:
		switch to {
		case StageServerReadyEnabled:
			return ServerState{Current: to}, nil
		case StageServerFailed:
			return ServerState{Current: to}, nil
		}
	case StageServerReadyDisabled:
		switch to {
		case StageServerReadyEnabled:
			return ServerState{Current: to}, nil
		case StageServerDeleted:
			if s.Pending != nil {
				return s, ErrServerApprovalInProgress
			}
			return ServerState{Current: StageServerDeleting, Pending: &ServerPendingTransition{From: s.Current, To: to, Fallback: StageServerReadyDisabled}}, nil
		}
	case StageServerReadyEnabled:
		switch to {
		case StageServerReadyDisabled:
			if s.Pending != nil {
				return s, ErrServerApprovalInProgress
			}
			return ServerState{Current: StageServerUpdating, Pending: &ServerPendingTransition{From: s.Current, To: to, Fallback: StageServerReadyEnabled}}, nil
		case StageServerDeleted:
			if s.Pending != nil {
				return s, ErrServerApprovalInProgress
			}
			return ServerState{Current: StageServerDeleting, Pending: &ServerPendingTransition{From: s.Current, To: to, Fallback: StageServerReadyEnabled}}, nil
		}
	case StageServerFailed:
		switch to {
		case StageServerDeleted:
			if s.Pending != nil {
				return s, ErrServerApprovalInProgress
			}
			return ServerState{Current: StageServerDeleting, Pending: &ServerPendingTransition{From: s.Current, To: to, Fallback: StageServerFailed}}, nil
		}
	}
	return s, ErrServerInvalidTransition
}

func (s ServerState) Commit() (ServerState, error) {
	if s.Pending == nil {
		return s, ErrServerNotInApproval
	}
	return ServerState{Current: s.Pending.To}, nil
}

func (s ServerState) Reject() (ServerState, error) {
	if s.Pending == nil {
		return s, ErrServerNotInApproval
	}
	return ServerState{Current: s.Pending.Fallback}, nil
}

func (s ServerState) IsApprovalPending() bool {
	return s.Pending != nil
}

func (s ServerState) ValidTransitions() []ServerStage {
	switch s.Current {
	case StageServerInit:
		return []ServerStage{StageServerProvisioning}
	case StageServerProvisioning:
		return []ServerStage{StageServerReadyEnabled, StageServerFailed}
	case StageServerReadyDisabled:
		return []ServerStage{StageServerReadyEnabled, StageServerDeleted}
	case StageServerReadyEnabled:
		return []ServerStage{StageServerReadyDisabled, StageServerDeleted}
	case StageServerFailed:
		return []ServerStage{StageServerDeleted}
	}
	return nil
}
